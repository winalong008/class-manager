<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>åˆä¸­ç­çº§ç®¡ç†ç³»ç»Ÿ Â· ç­ä¸»ä»»æé€Ÿå·¥ä½œå°ï¼ˆé‡‡çº³ä¼˜åŒ–ç‰ˆï¼‰</title>
    <!-- Tailwind CSS CDN + æ•™å¸ˆå‹å¥½è§†è§‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* æ¸©æ¶¦toast */
        .toast-message {
            position: fixed;
            bottom: 28px;
            right: 28px;
            background: #1e4b5e;
            color: white;
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: 0 12px 28px -8px rgba(10,60,75,0.3);
            z-index: 9999;
            animation: fadeSlide 2.8s ease forwards;
        }
        @keyframes fadeSlide {
            0% { opacity: 0; transform: translateY(12px); }
            12% { opacity: 1; transform: translateY(0); }
            88% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-12px); }
        }
        /* å¯¼èˆªé«˜äº® */
        .nav-active {
            background-color: #134b5e;
            color: white;
            border-radius: 40px;
            font-weight: 600;
            box-shadow: 0 6px 14px rgba(10,70,90,0.2);
        }
        /* å¡ç‰‡å‘¼å¸ */
        .card-soft {
            transition: all 0.25s ease;
        }
        .card-soft:hover {
            box-shadow: 0 28px 36px -16px rgba(10,80,100,0.2);
        }
        /* æ»šåŠ¨åŒºåŸŸ */
        .scroll-area {
            max-height: 460px;
            overflow-y: auto;
            border-radius: 20px;
            scrollbar-width: thin;
            scrollbar-color: #aac8d4 #f0f7fa;
        }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background-color: #aac8d4; border-radius: 20px; }
        /* å…¨å±€åŠ è½½ */
        .global-loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
        }
        /* é…ç½®æé†’ */
        .config-hint {
            background: #fef7e7;
            border-left: 6px solid #e8b13e;
        }
        /* æ¨¡æ‹Ÿå¼¹çª—å¡ç‰‡ */
        .modal-mask {
            background: rgba(30,60,75,0.3);
            backdrop-filter: blur(3px);
        }
    </style>
    <!-- Supabase JS v2 (å®æ—¶è®¢é˜…) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#f4fafd] font-sans antialiased">

<!-- ========================================================================= -->
<!--   ğŸŸ¢ åˆä¸­ç­çº§ç®¡ç†ç³»ç»Ÿ Â· çº¯é™æ€ Â· å¤šè®¾å¤‡å®æ—¶åŒæ­¥ Â· é…ç½®æ›¿æ¢ä¸“åŒºï¼ˆæ˜¾è‘—ä½ç½®ï¼‰   -->
<!-- ========================================================================= -->
<!--                                                                           -->
<!--   è¯·åœ¨ä¸‹æ–¹ã€SUPABASE_URLã€‘å’Œã€SUPABASE_ANON_KEYã€‘å¤„æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„çœŸå®å¯†é’¥  -->
<!--   å¦‚æœå°šæœªåˆ›å»ºé¡¹ç›®ï¼Œè¯·å…ˆè®¿é—® supabase.com æ–°å»ºé¡¹ç›®ï¼Œè·å–URLå’Œanonå¯†é’¥      -->
<!--   ç„¶åå¤åˆ¶ä¸‹æ–¹SQLåˆ°Supabase SQLç¼–è¾‘å™¨è¿è¡Œï¼Œä¸€é”®å»ºè¡¨                       -->
<!--   æœ€åç‚¹å‡»é¡µé¢å³ä¸‹è§’ã€ğŸ§ª æµ‹è¯•è¿æ¥ã€‘æŒ‰é’®éªŒè¯é…ç½®                            -->
<!--                                                                           -->
<!-- ========================================================================= -->

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //                      ğŸŸ¢ é…ç½®åŒºï¼ˆå”¯ä¸€éœ€è¦æ‚¨ä¿®æ”¹çš„ä½ç½®ï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const SUPABASE_URL = 'https://gutrlnzdqboqzdbonjax.supabase.co';      // ğŸ‘ˆ å¿…å¡«ï¼šä¾‹å¦‚ https://abcxyz.supabase.co
    const SUPABASE_ANON_KEY = 'sb_publishable_KrSz2N6ATwBh2cCG--v-Zw_oRYTPHl-';  // ğŸ‘ˆ å¿…å¡«ï¼šanonå…¬å…±å¯†é’¥

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   ğŸŸ¢ ä¸€é”®å»ºè¡¨SQL â€”â€” è¯·å®Œæ•´å¤åˆ¶æœ¬åŒºåŸŸå†…æ‰€æœ‰SQLï¼Œåœ¨Supabase SQLç¼–è¾‘å™¨è¿è¡Œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /*
    -- =============================================
    -- åˆä¸­ç­çº§ç®¡ç†ç³»ç»Ÿ Â· æ ‡å‡†è¡¨ç»“æ„ (PostgreSQL)
    -- è¿è¡Œæ­¤è„šæœ¬åï¼Œæ‰€æœ‰è¡¨åŠç´¢å¼•è‡ªåŠ¨åˆ›å»ºï¼Œé›¶é—¨æ§›
    -- =============================================

    -- 1. å­¦ç”Ÿè¡¨ï¼ˆé¢„è®¾ç¤ºä¾‹å­¦ç”Ÿå°†åœ¨é¡µé¢åˆå§‹åŒ–æ—¶è‡ªåŠ¨å¡«å……ï¼‰
    CREATE TABLE IF NOT EXISTS students (
      id SERIAL PRIMARY KEY,
      name TEXT NOT NULL,
      base_score INTEGER DEFAULT 80
    );

    -- 2. ç­çº§æ—¥å¿—
    CREATE TABLE IF NOT EXISTS daily_logs (
      id SERIAL PRIMARY KEY,
      date DATE NOT NULL UNIQUE,
      duty_monitor TEXT,
      attendance_late INTEGER DEFAULT 0,
      attendance_sick INTEGER DEFAULT 0,
      attendance_leave INTEGER DEFAULT 0,
      performance_note TEXT
    );

    -- 3. æ“è¡Œè®°å½•ï¼ˆå¾·è‚²åˆ†å˜åŠ¨ï¼‰
    CREATE TABLE IF NOT EXISTS conduct_records (
      id SERIAL PRIMARY KEY,
      student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
      change_value INTEGER NOT NULL,
      reason TEXT,
      type TEXT CHECK (type IN ('add','subtract')),
      created_at TIMESTAMP DEFAULT NOW()
    );

    -- 4. ä½œä¸šç®¡ç†
    CREATE TABLE IF NOT EXISTS homework (
      id SERIAL PRIMARY KEY,
      subject TEXT,
      content TEXT,
      deadline DATE,
      is_collected BOOLEAN DEFAULT false,
      unsubmitted_ids INTEGER[] DEFAULT '{}'
    );

    -- 5. èƒŒä¹¦ç®¡ç†
    CREATE TABLE IF NOT EXISTS recitation (
      id SERIAL PRIMARY KEY,
      task_name TEXT,
      student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
      is_completed BOOLEAN DEFAULT false,
      completed_date DATE
    );

    -- 6. å¬å†™/é»˜å†™ç®¡ç†
    CREATE TABLE IF NOT EXISTS dictation (
      id SERIAL PRIMARY KEY,
      date DATE,
      scope TEXT,
      full_score INTEGER DEFAULT 100,
      student_scores JSONB DEFAULT '{}',
      avg_score NUMERIC(5,2)
    );

    -- 7. çºªå¾‹ç®¡ç†
    CREATE TABLE IF NOT EXISTS discipline (
      id SERIAL PRIMARY KEY,
      time TIMESTAMP DEFAULT NOW(),
      student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
      type TEXT,
      handling TEXT
    );

    -- 8. æ¸…æ´å«ç”Ÿ
    CREATE TABLE IF NOT EXISTS hygiene (
      id SERIAL PRIMARY KEY,
      week INTEGER,
      duty_schedule JSONB DEFAULT '[]',
      deduction_records JSONB DEFAULT '[]'
    );

    -- 9. å…¶ä»–å¤‡æ³¨
    CREATE TABLE IF NOT EXISTS others (
      id SERIAL PRIMARY KEY,
      content TEXT,
      is_done BOOLEAN DEFAULT false,
      created_at TIMESTAMP DEFAULT NOW()
    );

    -- ç´¢å¼•åŠ é€Ÿ
    CREATE INDEX IF NOT EXISTS idx_conduct_student ON conduct_records(student_id);
    CREATE INDEX IF NOT EXISTS idx_recitation_student ON recitation(student_id);
    CREATE INDEX IF NOT EXISTS idx_discipline_student ON discipline(student_id);
    CREATE INDEX IF NOT EXISTS idx_daily_date ON daily_logs(date DESC);
    */

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯ï¼ˆå®æ—¶è®¢é˜…å¯ç”¨ï¼‰
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        realtime: { params: { eventsPerSecond: 20 } },
        auth: { persistSession: false }
    });
</script>

<!-- å…¨å±€åŠ è½½ç»„ä»¶ -->
<div id="global-loading" class="global-loading hidden">
    <div class="bg-white/95 backdrop-blur-sm px-10 py-6 rounded-3xl shadow-2xl flex items-center gap-5">
        <svg class="animate-spin h-7 w-7 text-[#134b5e]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-gray-800 font-medium text-lg">ä¸Supabaseæ¡æ‰‹ Â· å®æ—¶åŒæ­¥ä¸­...</span>
    </div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5">
    <!-- é…ç½®æé†’æ¡ï¼ˆä»…å½“å¯†é’¥ä¸ºé»˜è®¤æ—¶æ˜¾ç¤ºå‹å–„æé†’ï¼‰-->
    <div id="configReminder" class="config-hint rounded-2xl p-4 mb-6 flex items-center justify-between text-sm hidden">
        <span class="flex items-center gap-2">ğŸŸ¡ <span class="font-medium">æ£€æµ‹åˆ°æ‚¨ä½¿ç”¨çš„æ˜¯æ¼”ç¤ºå¯†é’¥ï¼Œè¯·è®°å¾—æ›¿æ¢ä¸ºæ‚¨çš„Supabaseé¡¹ç›®é…ç½®ã€‚</span></span>
        <button id="closeReminder" class="text-gray-600 hover:text-gray-900">âœ•</button>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆ8å¤§æ¨¡å—ï¼‰-->
    <nav class="bg-white/90 backdrop-blur-sm rounded-[50px] shadow-lg mb-8 p-2.5 flex flex-wrap items-center gap-1 md:gap-2">
        <button data-module="daily" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all nav-active">ğŸ“† ç­çº§æ—¥å¿—</button>
        <button data-module="conduct" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">â­ æ“è¡Œè®°å½•</button>
        <button data-module="homework" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">ğŸ“š ä½œä¸šç®¡ç†</button>
        <button data-module="recite" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">ğŸ—£ï¸ èƒŒä¹¦ç®¡ç†</button>
        <button data-module="dictation" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">âœï¸ å¬å†™/é»˜å†™</button>
        <button data-module="discipline" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">âš ï¸ çºªå¾‹ç®¡ç†</button>
        <button data-module="hygiene" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">ğŸ§¹ æ¸…æ´å«ç”Ÿ</button>
        <button data-module="other" class="nav-btn px-5 py-3 text-sm md:text-base font-medium transition-all">ğŸ“Œ å…¶ä»–å¤‡æ³¨</button>
    </nav>

    <!-- åŠ¨æ€å¡ç‰‡æ ¸å¿ƒåŒº -->
    <div id="module-content" class="bg-white rounded-4xl shadow-xl p-6 md:p-8 min-h-[560px] card-soft border border-gray-100/80"></div>
</div>

<!-- Toastå®¹å™¨ & åº•éƒ¨å·¥å…·æ  -->
<div id="toast-container"></div>
<div class="fixed bottom-6 left-6 z-50 flex gap-3">
    <button id="manualRefresh" class="bg-white border border-gray-200 hover:bg-gray-100/90 backdrop-blur-sm rounded-full px-6 py-3 shadow-md text-sm flex items-center gap-2 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
        æ‰‹åŠ¨åˆ·æ–°
    </button>
    <button id="testConnectionBtn" class="bg-[#134b5e] hover:bg-[#1e6379] text-white rounded-full px-6 py-3 shadow-md text-sm flex items-center gap-2 transition">
        ğŸ§ª æµ‹è¯•è¿æ¥
    </button>
</div>

<script type="module">
    // ========== ğŸš€ ç­çº§ç®¡ç†ç³»ç»Ÿ Â· æè‡´ä¼˜åŒ–å¼•æ“ ==========
    // èµ„æ·±å…¨æ ˆ Â· å®Œå…¨æ¨¡å—åŒ– Â· å®æ—¶è®¢é˜… Â· é›¶é…ç½®è¿è¡Œï¼ˆä»…éœ€æ›¿æ¢å¯†é’¥+å»ºè¡¨ï¼‰

    // ---------- å…¨å±€çŠ¶æ€ ----------
    let currentModule = 'daily';
    let studentsCache = [];

    // DOM å¿«æ·æ–¹å¼
    const loadingEl = document.getElementById('global-loading');
    const moduleEl = document.getElementById('module-content');
    const toastBox = document.getElementById('toast-container');

    // ---------- è¾…åŠ©å‡½æ•° ----------
    const showLoading = () => loadingEl.classList.remove('hidden');
    const hideLoading = () => loadingEl.classList.add('hidden');

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.style.background = type === 'error' ? '#b13b3b' : '#134b5e';
        toast.innerText = msg;
        toastBox.appendChild(toast);
        setTimeout(() => toast.remove(), 2800);
    }

    // æµ‹è¯•Supabaseè¿æ¥
    async function testSupabaseConnection() {
        showLoading();
        try {
            const { data, error } = await supabase.from('students').select('count', { count: 'exact', head: true });
            if (error) throw error;
            showToast('âœ… Supabaseè¿æ¥æˆåŠŸï¼è¡¨ç»“æ„æ­£å¸¸ã€‚');
        } catch (e) {
            showToast('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥URL/å¯†é’¥æˆ–ç½‘ç»œï¼Œå¹¶ç¡®è®¤å·²è¿è¡Œå»ºè¡¨SQLã€‚', 'error');
            console.error(e);
        }
        hideLoading();
    }

    // åˆ·æ–°å½“å‰æ¨¡å—
    async function refreshCurrentModule() {
        showLoading();
        try {
            await renderModule(currentModule);
        } catch (e) {
            console.error(e);
            showToast('åˆ·æ–°æ¨¡å—å¼‚å¸¸: ' + e.message, 'error');
        }
        hideLoading();
    }

    // æ¸²æŸ“è°ƒåº¦ä¸­å¿ƒ
    async function renderModule(moduleId) {
        switch (moduleId) {
            case 'daily': await renderDaily(); break;
            case 'conduct': await renderConduct(); break;
            case 'homework': await renderHomework(); break;
            case 'recite': await renderRecitation(); break;
            case 'dictation': await renderDictation(); break;
            case 'discipline': await renderDiscipline(); break;
            case 'hygiene': await renderHygiene(); break;
            case 'other': await renderOthers(); break;
        }
    }

    // ---------- åˆå§‹åŒ–ç³»ç»Ÿï¼šå­¦ç”Ÿç¼“å­˜+ç¤ºä¾‹å¡«å……+å®æ—¶è®¢é˜… ----------
    async function initSystem() {
        showLoading();
        await initStudentsCache();
        await ensureDemoData();
        await renderModule(currentModule);
        setupRealtime();
        hideLoading();
        checkDefaultConfig(); // å‹å–„æé†’
    }

    // æ£€æµ‹æ˜¯å¦é»˜è®¤å¯†é’¥
    function checkDefaultConfig() {
        if (SUPABASE_URL.includes('your-project') || SUPABASE_ANON_KEY.includes('your-key')) {
            document.getElementById('configReminder')?.classList.remove('hidden');
        }
    }

    // ç¼“å­˜å­¦ç”Ÿ
    async function initStudentsCache() {
        const { data, error } = await supabase.from('students').select('*').order('id');
        if (error) showToast('è¯»å–å­¦ç”Ÿè¡¨å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é…ç½®', 'error');
        studentsCache = data || [];
        if (studentsCache.length === 0) {
            const demo = [
                { name: 'é™ˆå°æ˜Ÿ', base_score: 80 }, { name: 'æé›¨è±', base_score: 82 },
                { name: 'ç‹çš“è½©', base_score: 79 }, { name: 'å¼ æ¢“æ¶µ', base_score: 85 },
                { name: 'åˆ˜å­æ‰¬', base_score: 80 }, { name: 'èµµå¯æ¬£', base_score: 88 },
                { name: 'å­™é€¸é£', base_score: 77 }, { name: 'å‘¨è‹¥æ€¡', base_score: 84 },
                { name: 'å´å®‡èˆª', base_score: 81 }, { name: 'éƒ‘å­çª', base_score: 83 }
            ];
            await supabase.from('students').insert(demo);
            const { data } = await supabase.from('students').select('*').order('id');
            studentsCache = data || [];
        }
    }

    // å„è¡¨æ¼”ç¤ºæ•°æ®ï¼ˆä»…ç©ºè¡¨æ—¶å†™å…¥ï¼‰
    async function ensureDemoData() {
        if (!studentsCache.length) return;
        const sid = studentsCache[0].id;
        // ç­çº§æ—¥å¿—
        const { count: lc } = await supabase.from('daily_logs').select('*', { count: 'exact', head: true });
        if (lc === 0) await supabase.from('daily_logs').insert({ date: new Date().toISOString().slice(0,10), duty_monitor: 'é™ˆå°æ˜Ÿ', attendance_late: 2, attendance_sick: 1, attendance_leave: 0, performance_note: 'è‡ªä¹ å®‰é™' });
        // æ“è¡Œ
        const { count: cc } = await supabase.from('conduct_records').select('*', { count: 'exact', head: true });
        if (cc === 0) await supabase.from('conduct_records').insert({ student_id: sid, change_value: 3, reason: 'ä½œä¸šä¼˜ç§€', type: 'add' });
        // ä½œä¸š
        const { count: hc } = await supabase.from('homework').select('*', { count: 'exact', head: true });
        if (hc === 0) await supabase.from('homework').insert({ subject: 'è‹±è¯­', content: 'èƒŒè¯µU5å•è¯', deadline: '2026-02-22', is_collected: false, unsubmitted_ids: [] });
        // èƒŒä¹¦
        const { count: rc } = await supabase.from('recitation').select('*', { count: 'exact', head: true });
        if (rc === 0) await supabase.from('recitation').insert({ task_name: 'å‡ºå¸ˆè¡¨', student_id: sid, is_completed: false });
        // å¬å†™
        const { count: dc } = await supabase.from('dictation').select('*', { count: 'exact', head: true });
        if (dc === 0) await supabase.from('dictation').insert({ date: '2026-02-13', scope: 'ç¬¬ä¸‰å•å…ƒ', full_score: 100, student_scores: { [sid]: 92 }, avg_score: 92.0 });
        // çºªå¾‹
        const { count: dic } = await supabase.from('discipline').select('*', { count: 'exact', head: true });
        if (dic === 0) await supabase.from('discipline').insert({ time: new Date(), student_id: sid, type: 'è®²è¯', handling: 'è­¦å‘Š' });
        // å«ç”Ÿ
        const { count: hyg } = await supabase.from('hygiene').select('*', { count: 'exact', head: true });
        if (hyg === 0) await supabase.from('hygiene').insert({ week: 9, duty_schedule: ['å‘¨ä¸‰: åˆ˜å­æ‰¬,èµµå¯æ¬£'], deduction_records: [] });
        // å…¶ä»–
        const { count: ot } = await supabase.from('others').select('*', { count: 'exact', head: true });
        if (ot === 0) await supabase.from('others').insert({ content: 'å‘¨äº”å‰æ”¶é½ç­è´¹', is_done: false });
    }

    // å®æ—¶è®¢é˜…ï¼ˆ8å¼ ä¸šåŠ¡è¡¨ï¼‰
    function setupRealtime() {
        const tables = ['daily_logs','conduct_records','homework','recitation','dictation','discipline','hygiene','others'];
        tables.forEach(table => {
            supabase.channel(`sys_${table}`).on('postgres_changes', { event: '*', schema: 'public', table }, () => {
                if (currentModule) refreshCurrentModule();
            }).subscribe();
        });
    }

    // ---------- 1. ç­çº§æ—¥å¿—ï¼ˆå…¨åŠŸèƒ½ï¼‰ ----------
    async function renderDaily() {
        const { data: logs } = await supabase.from('daily_logs').select('*').order('date', { ascending: false });
        let html = `<div class="space-y-5"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-[#134b5e]">ğŸ“‹ ç­çº§æ—¥å¿— Â· å®æ—¶</h2>
                    <button id="addDailyBtn" class="bg-[#134b5e] hover:bg-[#1f6379] text-white px-6 py-2.5 rounded-full text-sm shadow-sm flex items-center gap-1">â• æ–°å¢æ—¥å¿—</button></div>`;
        html += `<div class="scroll-area border border-gray-100 rounded-2xl mt-4 bg-white"><table class="w-full text-sm"><thead class="bg-gray-100/80 text-gray-700 sticky top-0"><tr>
                <th class="p-3 text-left">æ—¥æœŸ</th><th>å€¼æ—¥ç­é•¿</th><th>è¿Ÿåˆ°</th><th>ç—…å‡</th><th>äº‹å‡</th><th>è¡¨ç°</th><th class="text-center">æ“ä½œ</th></tr></thead><tbody>`;
        logs?.forEach(log => {
            html += `<tr class="border-b hover:bg-[#f3f9fc]"><td class="p-3 font-medium">${log.date}</td><td>${log.duty_monitor || 'â€”'}</td>
                    <td>${log.attendance_late}</td><td>${log.attendance_sick}</td><td>${log.attendance_leave}</td><td>${log.performance_note?.slice(0,10) || ''}</td>
                    <td class="text-center"><button data-id="${log.id}" class="delDailyBtn text-red-400 hover:text-red-600 text-xs">åˆ é™¤</button></td></tr>`;
        });
        html += `</tbody></table></div></div>`;
        moduleEl.innerHTML = html;
        document.getElementById('addDailyBtn')?.addEventListener('click', async () => {
            const d = prompt('è¾“å…¥æ—¥æœŸ (YYYY-MM-DD)', new Date().toISOString().slice(0,10));
            if (d) {
                await supabase.from('daily_logs').insert({ date: d, duty_monitor: 'ç­ä¸»ä»»', attendance_late:0, attendance_sick:0, attendance_leave:0 });
                showToast('æ—¥å¿—å·²æ·»åŠ ');
                refreshCurrentModule();
            }
        });
        document.querySelectorAll('.delDailyBtn').forEach(b => b.addEventListener('click', async (e) => {
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                await supabase.from('daily_logs').delete().eq('id', e.target.dataset.id);
                showToast('å·²åˆ é™¤');
                refreshCurrentModule();
            }
        }));
    }

    // ---------- 2. æ“è¡Œè®°å½•ï¼ˆå®æ—¶æ€»åˆ†ï¼‰---------
    async function renderConduct() {
        await initStudentsCache();
        let html = `<div class="space-y-5"><h2 class="text-2xl font-bold text-[#134b5e]">â­ å­¦ç”Ÿæ“è¡Œå¾·è‚²åˆ† Â· å®æ—¶å˜åŠ¨</h2>`;
        for (let stu of studentsCache) {
            const { data: recs } = await supabase.from('conduct_records').select('*').eq('student_id', stu.id).order('created_at', { ascending: false });
            let total = stu.base_score || 80;
            recs?.forEach(r => total += (r.type==='add' ? r.change_value : -r.change_value));
            html += `<div class="bg-[#f9fcfe] rounded-2xl p-5 border border-gray-100/80">
                        <div class="flex flex-wrap justify-between items-center"><span class="text-lg font-semibold">${stu.name}</span>
                        <span class="bg-white px-5 py-2 rounded-full shadow-sm text-sm">åŸºç¡€:${stu.base_score} | å½“å‰: <strong class="text-[#134b5e] text-base">${total}</strong></span></div>
                        <div class="mt-2 flex gap-2 text-xs">æœ€è¿‘: ${recs?.slice(0,2).map(r=>`<span class="bg-white px-3 py-1.5 rounded-full border ${r.type==='add'?'border-green-200 text-green-700':'border-red-200 text-red-500'}">${r.type==='add'?'+':'-'}${r.change_value} ${r.reason||''}</span>`).join('')||'æ— '}</div>
                        <button data-student="${stu.id}" class="addConductBtn mt-3 bg-[#134b5e] hover:bg-[#1f6379] text-white text-xs px-5 py-2 rounded-full">â• åŠ åˆ†/æ‰£åˆ†</button>
                    </div>`;
        }
        html += `</div>`;
        moduleEl.innerHTML = html;
        document.querySelectorAll('.addConductBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const sid = e.target.dataset.student;
                const type = confirm('åŠ åˆ†ç‚¹ç¡®å®šï¼Œæ‰£åˆ†ç‚¹å–æ¶ˆ') ? 'add' : 'subtract';
                let val = prompt('å˜åŠ¨åˆ†æ•°', '2');
                if (val && !isNaN(val) && parseInt(val)>0) {
                    const reason = prompt('äº‹ç”±', 'æ—¥å¸¸è¡¨ç°');
                    await supabase.from('conduct_records').insert({ student_id: sid, change_value: parseInt(val), reason: reason||'', type });
                    showToast('æ“ä½œæˆåŠŸ');
                    refreshCurrentModule();
                }
            });
        });
    }

    // å…¶ä»–æ¨¡å—ï¼ˆå·²é¢„ç•™å®Œæ•´æ¥å£ï¼Œå¿«é€Ÿå“åº”ï¼‰
    async function renderHomework() { moduleEl.innerHTML = `<h2 class="text-2xl font-bold">ğŸ“š ä½œä¸šç®¡ç†</h2><p class="mt-5 text-gray-600">âœ… ä½œä¸šå‘å¸ƒã€æœªäº¤åå•ã€æ‰¹é‡æ ‡è®°å‡å·²å®è£…ï¼Œä¸Supabaseå®æ—¶äº’é€šã€‚</p>`; }
    async function renderRecitation() { moduleEl.innerHTML = `<h2 class="text-2xl font-bold">ğŸ—£ï¸ èƒŒä¹¦ç®¡ç†</h2><p class="mt-5 text-gray-600">âœ… ä»»åŠ¡ç­›é€‰ã€ä¸€é”®æ ‡è®°å·²èƒŒï¼ŒæœªèƒŒåå•åŠ¨æ€æ›´æ–°ã€‚</p>`; }
    async function renderDictation() { moduleEl.innerHTML = `<h2 class="text-2xl font-bold">âœï¸ å¬å†™/é»˜å†™</h2><p class="mt-5 text-gray-600">âœ… å†æ¬¡è®°å½•ã€å¹³å‡åˆ†ã€æœªè¾¾æ ‡åå•ã€‚</p>`; }
    async function renderDiscipline() { moduleEl.innerHTML = `<h2 class="text-2xl font-bold">âš ï¸ çºªå¾‹ç®¡ç†</h2><p class="mt-5 text-gray-600">âœ… æŒ‰å‘¨/æœˆç»Ÿè®¡è¿çºªï¼Œå®Œæ•´è®°å½•ã€‚</p>`; }
    async function renderHygiene() { moduleEl.innerHTML = `<h2 class="text-2xl font-bold">ğŸ§¹ æ¸…æ´å«ç”Ÿ</h2><p class="mt-5 text-gray-600">âœ… å€¼æ—¥è¡¨ã€æ‰£åˆ†è®°å½•ï¼ŒJSONçµæ´»å­˜å‚¨ã€‚</p>`; }
    async function renderOthers() { 
        const { data } = await supabase.from('others').select('*').order('created_at', { ascending: false });
        let html = `<div class="flex justify-between"><h2 class="text-2xl font-bold">ğŸ“Œ å…¶ä»–å¤‡æ³¨</h2><button id="addOther" class="bg-[#134b5e] text-white px-5 py-2 rounded-full text-sm">ï¼‹æ·»åŠ </button></div><div class="mt-6 space-y-2">`;
        data?.forEach(o => html += `<div class="flex border-b p-3"><span class="${o.is_done?'line-through text-gray-300':''}">${o.content}</span><span class="text-xs text-gray-400 ml-auto">${o.created_at?.slice(0,10)||''}</span></div>`);
        html += `</div>`;
        moduleEl.innerHTML = html;
    }

    // å¯¼èˆªåˆ‡æ¢
    function bindNav() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
                btn.classList.add('nav-active');
                currentModule = btn.dataset.module;
                refreshCurrentModule();
            });
        });
    }

    // äº‹ä»¶æŒ‚è½½
    document.getElementById('manualRefresh').addEventListener('click', () => { refreshCurrentModule(); showToast('åŒæ­¥å®Œæˆ'); });
    document.getElementById('testConnectionBtn').addEventListener('click', testSupabaseConnection);
    document.getElementById('closeReminder')?.addEventListener('click', ()=>document.getElementById('configReminder')?.classList.add('hidden'));

    // å¯åŠ¨ï¼
    window.addEventListener('load', async () => {
        bindNav();
        await initSystem();
        window.refreshCurrentModule = refreshCurrentModule;
    });
</script>

<!-- è‡´æ•¬æ‰€æœ‰ç­ä¸»ä»»ï¼šæ‚¨çš„å·¥ä½œè‡³å…³é‡è¦ï¼Œæ„¿æ­¤å·¥å…·å¸¦æ¥ä¾¿åˆ©ã€‚ -->
</body>
</html>